#!/usr/bin/env python3

import argparse
import sys

from colorama import Fore, Back, Style

from ietf_comments import __version__
from ietf_comments.github import create_issues
from ietf_comments.parser import parse_comments


def parse_args():
    parser = argparse.ArgumentParser(description="Process an IETF comments file")
    parser.add_argument(
        "-g",
        "--github_repo",
        dest="github_repo",
        help="create issues in the named repo; e.g., username/reponame",
    )

    parser.add_argument(
        "-l",
        "--github-label",
        dest="github_label",
        nargs="*",
        help="label(s) to assign to created GitHub issues",
    )

    parser.add_argument(
        "-v",
        "--version",
        action="version",
        version=f"{__version__}",
        help="print version and exit",
    )

    parser.add_argument(
        "comment_file",
        nargs="+",
        type=argparse.FileType("r"),
        help="comment file(s) to process",
    )

    return parser.parse_args()


class Cli:
    @classmethod
    def out(cls, content):
        sys.stdout.write(content)

    @classmethod
    def status(cls, message):
        sys.stderr.write(f"{message}\n")

    @classmethod
    def warn(cls, message):
        sys.stderr.write(f"{Fore.YELLOW}Warning{Style.RESET_ALL}: {message}\n")

    @classmethod
    def error(cls, message):
        sys.stderr.write(f"{Fore.RED}Error{Style.RESET_ALL}: {message}\n")
        sys.exit(1)


if __name__ == "__main__":
    args = parse_args()
    cli = Cli()
    for comment_file in args.comment_file:
        comments = parse_comments(comment_file, cli)
        labels = args.github_label or []
        if args.github_repo:
            create_issues(args.github_repo, cli, comments, labels)
        else:
            cli.out(str(comments))
